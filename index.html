<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>LetBook</title>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/4.1.0/turn.min.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:#f4f4f4;transition:.3s}
.dark{background:#0f0f0f;color:#eee}
.hidden{display:none}

header{
background:white;padding:15px 30px;display:flex;justify-content:space-between;
align-items:center;box-shadow:0 2px 12px rgba(0,0,0,0.08)
}
.dark header{background:#1a1a1a}

button,input{
padding:10px;border-radius:8px;border:none;margin:5px
}
button{background:#ff9900;color:white;cursor:pointer}

#books{
display:grid;grid-template-columns:repeat(auto-fill,180px);
gap:25px;padding:30px
}

.book{
background:white;padding:15px;border-radius:14px;text-align:center;
cursor:pointer;transition:.3s
}
.dark .book{background:#1e1e1e}
.book:hover{transform:translateY(-6px)}

.book-cover{
height:200px;background:linear-gradient(135deg,#ff9900,#ff5500);
border-radius:10px;margin-bottom:10px
}

#reader{height:100vh;background:#e5e5e5}
.dark #reader{background:#000}

.reader-bar{
padding:12px 20px;background:white;
display:flex;justify-content:space-between;align-items:center
}
.dark .reader-bar{background:#1a1a1a}

#progressBar{
height:5px;background:#ddd;width:100%
}
#progress{
height:5px;background:#ff9900;width:0%
}

#flipbook{
width:900px;height:600px;margin:20px auto;position:relative
}

.page{background:white;position:relative}
.dark .page{background:#222}

canvas{width:100%;height:100%}

.highlight{
position:absolute;background:rgba(255,255,0,0.4);
pointer-events:none
}

textarea{
position:absolute;width:200px;height:100px;
background:#fff8c4;border:1px solid #ccc;
resize:none;padding:5px;font-size:12px
}
</style>
</head>
<body>

<header>
<h3>üìö LetBook</h3>
<div>
<input type="file" id="upload" accept="application/pdf">
<button onclick="toggleDark()">üåô</button>
</div>
</header>

<div id="library">
<div id="books"></div>
</div>

<div id="reader" class="hidden">
<div class="reader-bar">
<button onclick="closeReader()">‚¨Ö Biblioteca</button>
<div>
<button onclick="zoomIn()">üîç+</button>
<button onclick="zoomOut()">üîç-</button>
<button onclick="enableHighlight()">‚úçÔ∏è Marca-texto</button>
<button onclick="addNote()">üìù Nota</button>
</div>
</div>
<div id="progressBar"><div id="progress"></div></div>
<div id="flipbook"></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

let zoom=1.3;
let currentBook=null;
let highlightMode=false;

function toggleDark(){document.body.classList.toggle("dark")}

upload.addEventListener("change",e=>{
const file=e.target.files[0];
const reader=new FileReader();
reader.onload=function(){
let books=JSON.parse(localStorage.getItem("letbook_books"))||[];
books.push({name:file.name,data:this.result});
localStorage.setItem("letbook_books",JSON.stringify(books));
loadBooks();
};
reader.readAsArrayBuffer(file);
});

function loadBooks(){
const books=JSON.parse(localStorage.getItem("letbook_books"))||[];
booksContainer=document.getElementById("books");
booksContainer.innerHTML="";
books.forEach((b,i)=>{
let div=document.createElement("div");
div.className="book";
div.innerHTML=`<div class="book-cover"></div><strong>${b.name}</strong>`;
div.onclick=()=>openBook(i);
booksContainer.appendChild(div);
});
}
loadBooks();

function openBook(index){
currentBook=index;
library.classList.add("hidden");
reader.classList.remove("hidden");
let books=JSON.parse(localStorage.getItem("letbook_books"));
renderPDF(books[index].data);
}

function renderPDF(data){
flipbook.innerHTML="";
pdfjsLib.getDocument(new Uint8Array(data)).promise.then(pdf=>{
for(let i=1;i<=pdf.numPages;i++){
pdf.getPage(i).then(page=>{
const viewport=page.getViewport({scale:zoom});
const canvas=document.createElement("canvas");
const context=canvas.getContext("2d");
canvas.width=viewport.width;
canvas.height=viewport.height;
const div=document.createElement("div");
div.className="page";
div.appendChild(canvas);
flipbook.appendChild(div);
page.render({canvasContext:context,viewport});
});
}

setTimeout(()=>{
$('#flipbook').turn({
width:900,height:600,autoCenter:true
});

const saved=localStorage.getItem("letbook_page_"+currentBook);
if(saved)$('#flipbook').turn('page',parseInt(saved));

$('#flipbook').bind('turned',function(e,page){
localStorage.setItem("letbook_page_"+currentBook,page);
updateProgress(page,pdf.numPages);
});

updateProgress($('#flipbook').turn('page'),pdf.numPages);
},1000);
});
}

function updateProgress(page,total){
let percent=Math.round((page/total)*100);
document.getElementById("progress").style.width=percent+"%";
}

function closeReader(){
$('#flipbook').turn('destroy');
reader.classList.add("hidden");
library.classList.remove("hidden");
}

function zoomIn(){zoom+=0.2;reopen()}
function zoomOut(){zoom-=0.2;reopen()}

function reopen(){
$('#flipbook').turn('destroy');
let books=JSON.parse(localStorage.getItem("letbook_books"));
renderPDF(books[currentBook].data);
}

function enableHighlight(){
highlightMode=!highlightMode;
alert(highlightMode?"Modo marca-texto ativado":"Modo marca-texto desativado");
}

document.addEventListener("mousedown",e=>{
if(!highlightMode)return;
if(!e.target.closest(".page"))return;

let rect=e.target.closest(".page").getBoundingClientRect();
let highlight=document.createElement("div");
highlight.className="highlight";
highlight.style.left=(e.clientX-rect.left)+"px";
highlight.style.top=(e.clientY-rect.top)+"px";
highlight.style.width="100px";
highlight.style.height="20px";
e.target.closest(".page").appendChild(highlight);
});

function addNote(){
let page=$('#flipbook').turn('page');
let pageDiv=document.querySelectorAll(".page")[page-1];
let note=document.createElement("textarea");
note.placeholder="Sua anota√ß√£o...";
note.style.left="50px";
note.style.top="50px";
pageDiv.appendChild(note);
}
</script>

</body>
</html>